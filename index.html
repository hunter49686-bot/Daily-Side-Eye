<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>The Daily Side-Eye</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
  body{font-family:Arial,Helvetica,sans-serif;margin:0;background:#fff;color:#111}
  .wrap{max-width:1100px;margin:0 auto;padding:18px}
  h1{font-size:42px;margin:0}
  .tagline{color:#444;margin-top:6px}
  .topbar{display:flex;justify-content:space-between;align-items:flex-start;gap:12px}
  .rightnow{color:#555;text-align:right;white-space:nowrap}
  .hr{height:2px;background:#e5e5e5;margin:12px 0 14px}

  .columns{display:grid;grid-template-columns:1fr 1fr 1fr;gap:28px}
  @media(max-width:900px){.columns{grid-template-columns:1fr}}

  .section-title{
    font-weight:900;
    font-size:24px;
    letter-spacing:1px;
    margin:18px 0 8px;
  }
  .rule{height:2px;background:#e5e5e5;margin-bottom:10px}

  .item{margin-bottom:18px}
  a.headline{font-weight:800;font-size:22px;color:#111;text-decoration:none}
  a.feature{color:#b00000;font-size:30px}
  .source{color:#666}

  .sub{font-size:16px;margin-top:5px;color:#222}

  .badge{border:1px solid #bbb;border-radius:999px;padding:2px 8px;font-size:12px;margin-right:6px}
  .ages{border:1px solid #c8a400;background:#fff7cc;border-radius:999px;padding:2px 8px;font-size:12px;margin-right:6px}

  .footer{border-top:2px solid #e5e5e5;margin-top:26px;padding-top:14px}
  .footer h2{margin:0 0 10px;font-size:22px;letter-spacing:1px}
</style>
</head>

<body>
<div class="wrap">

  <div class="topbar">
    <div>
      <h1 id="title"></h1>
      <div id="tagline" class="tagline"></div>
    </div>
    <div class="rightnow">
      <div id="today"></div>
      <div id="nowtime"></div>
    </div>
  </div>

  <div class="hr"></div>

  <div id="updated"></div>

  <div id="cols" class="columns"></div>

  <div class="footer">
    <h2>THE WEEK IN HINDSIGHT</h2>
    <ul id="week"></ul>
  </div>

</div>

<script>
  function fmtDate(d){
    return d.toLocaleDateString(undefined, {weekday:'long', year:'numeric', month:'long', day:'numeric'});
  }
  function fmtTime(d){
    return d.toLocaleTimeString(undefined, {hour:'numeric', minute:'2-digit'});
  }

  // Hard-limit what we display so you never get "extra sections"
  const SECTION_ORDER = ["Breaking","Top","Business","Tech","Weird"];

  // Render exactly 3 columns with these sections:
  // Col 1: Breaking, Top
  // Col 2: Business
  // Col 3: Tech, Weird
  const COLUMN_PLAN = [
    ["Breaking","Top"],
    ["Business"],
    ["Tech","Weird"]
  ];

  function buildSectionHTML(sec){
    const secName = String(sec.name || "");
    let html = '<div class="section-title">' + secName.toUpperCase() + '</div><div class="rule"></div>';

    (sec.items || []).forEach(it => {
      const ages = it.ages_poorly ? '<span class="ages">IF THIS AGES POORLY</span>' : '';
      const badge = it.badge ? '<span class="badge">' + it.badge + '</span>' : '';
      const headlineClass = "headline" + (it.feature ? " feature" : "");

      html +=
        '<div class="item">' +
          ages + badge +
          '<a class="' + headlineClass + '" href="' + it.url + '" target="_blank" rel="noopener noreferrer">' +
            (it.title || "") +
          '</a>' +
          '<span class="source"> (' + (it.source || "") + ')</span>' +
          '<div class="sub">' + (it.snark || "") + '</div>' +
        '</div>';
    });

    return html;
  }

  // Cache-bust headlines.json so updates appear even on mobile caches
  fetch("headlines.json?cb=" + Date.now())
    .then(r => r.json())
    .then(d => {
      document.getElementById("title").textContent = d.site?.name || "THE DAILY SIDE-EYE";
      document.getElementById("tagline").textContent = d.site?.tagline || "Headlines with a raised eyebrow.";

      const now = new Date();
      document.getElementById("today").textContent = fmtDate(now);
      document.getElementById("nowtime").textContent = fmtTime(now);

      const gen = new Date(d.generated_utc);
      document.getElementById("updated").textContent = "Last updated: " + gen.toLocaleString();

      // Flatten all sections from JSON into a map by name (dedupe by name)
      const secMap = {};
      (d.columns || []).forEach(col => {
        (col.sections || []).forEach(sec => {
          const name = String(sec.name || "");
          if (!name) return;
          // If duplicates exist, keep the one with more items
          if (!secMap[name] || ((sec.items||[]).length > (secMap[name].items||[]).length)){
            secMap[name] = sec;
          }
        });
      });

      // Build exactly the layout you want (no extras)
      const cols = document.getElementById("cols");
      cols.innerHTML = "";

      COLUMN_PLAN.forEach(colNames => {
        const c = document.createElement("div");
        colNames.forEach(name => {
          if (secMap[name]) {
            const container = document.createElement("div");
            container.innerHTML = buildSectionHTML(secMap[name]);
            c.appendChild(container);
          }
        });
        cols.appendChild(c);
      });

      // Week in hindsight
      const week = document.getElementById("week");
      week.innerHTML = "";
      (d.week_in_hindsight || []).forEach(line => {
        const li = document.createElement("li");
        li.textContent = line;
        week.appendChild(li);
      });
    })
    .catch(err => {
      document.getElementById("updated").textContent = "Error loading headlines.json.";
      console.error(err);
    });
</script>

</body>
</html>