name: Update Sections (Staggered)

on:
  schedule:
    # We keep all 5 schedules, but we DON'T depend on "which cron fired".
    # The job looks at current UTC time and runs only the section(s) due.
    - cron: "7,37 * * * *"     # Breaking
    - cron: "11 */2 * * *"     # Policy
    - cron: "23 */2 * * *"     # Money
    - cron: "41 */2 * * *"     # Tech
    - cron: "53 */2 * * *"     # Weird

  workflow_dispatch:
    inputs:
      section:
        description: "Which section to update (breaking/policy/money/tech/weird/all)"
        required: true
        default: "all"

permissions:
  contents: write

concurrency:
  group: update-sections
  cancel-in-progress: true

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # helps avoid some push/rebase edge cases

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - run: pip install -r requirements.txt

      - name: Decide what to update (UTC) + run generator
        shell: bash
        run: |
          set -euo pipefail

          # Manual run: respect the input
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            SECTION="${{ inputs.section }}"
            echo "Manual run requested: ${SECTION}"
            if [[ "${SECTION}" == "all" ]]; then
              python update_headlines.py --section breaking
              python update_headlines.py --section policy
              python update_headlines.py --section money
              python update_headlines.py --section tech
              python update_headlines.py --section weird
            else
              python update_headlines.py --section "${SECTION}"
            fi
            exit 0
          fi

          # Scheduled run: look at real UTC time
          MINUTE="$(date -u +%M)"
          HOUR="$(date -u +%H)"
          HOUR_NUM=$((10#$HOUR))
          MIN_NUM=$((10#$MINUTE))

          echo "Scheduled run UTC time: hour=${HOUR_NUM} minute=${MIN_NUM}"

          # Breaking at :07 and :37 every hour
          if [[ "$MIN_NUM" -eq 7 || "$MIN_NUM" -eq 37 ]]; then
            echo "Due: breaking"
            python update_headlines.py --section breaking
          fi

          # For 2-hour sections: only run on even UTC hours
          if (( HOUR_NUM % 2 == 0 )); then
            if [[ "$MIN_NUM" -eq 11 ]]; then
              echo "Due: policy"
              python update_headlines.py --section policy
            fi
            if [[ "$MIN_NUM" -eq 23 ]]; then
              echo "Due: money"
              python update_headlines.py --section money
            fi
            if [[ "$MIN_NUM" -eq 41 ]]; then
              echo "Due: tech"
              python update_headlines.py --section tech
            fi
            if [[ "$MIN_NUM" -eq 53 ]]; then
              echo "Due: weird"
              python update_headlines.py --section weird
            fi
          fi

      - name: Commit and push (if changed)
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "dailysideeye-bot"
          git config user.email "actions@users.noreply.github.com"

          git add headlines.json

          # If nothing changed, do nothing
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Update headlines.json"

          # Rebase/push to reduce non-fast-forward failures
          git pull --rebase
          git push
